[[ARP]]
## С устройством L3:

Когда устройство уровня 3 (например, маршрутизатор) получает пакет, оно использует протокол ARP (Address Resolution Protocol), чтобы определить MAC-адрес устройства, связанного с IP-адресом в локальной сети. ARP работает только в пределах одной сети канального уровня (L2). Вот пошаговое объяснение:

---

### **1. Определение принадлежности IP-адреса к сети**

Маршрутизатор сначала проверяет, принадлежит ли целевой IP-адрес (тот, к которому нужно доставить пакет) к его локальной сети:

- Если адрес принадлежит той же сети (например, в пределах одной VLAN), он использует ARP для нахождения MAC-адреса.
- Если адрес находится в другой сети, маршрутизатор отправляет запрос следующему маршрутизатору (в сторону шлюза или другого L3-устройства).

---

### **2. Проверка ARP-кэша**

Перед отправкой ARP-запроса маршрутизатор проверяет свой ARP-кэш:

- Если в кэше уже есть запись с MAC-адресом, соответствующим IP-адресу, он использует её и пересылает пакет.
- Если записи нет, переходит к следующему шагу.

---

### **3. Формирование ARP-запроса**

Маршрутизатор формирует ARP-запрос:

- **Источник**: IP-адрес и MAC-адрес интерфейса маршрутизатора.
- **Назначение**: IP-адрес целевого устройства, MAC-адрес в заголовке Ethernet устанавливается в `FF:FF:FF:FF:FF:FF` (широковещательный адрес).

Пример ARP-запроса:

`"Кто обладает IP-адресом 192.168.1.10? Сообщите свой MAC-адрес."`

---

### **4. Отправка ARP-запроса**

- ARP-запрос отправляется в широковещательном режиме (broadcast) по локальной сети. Все устройства в пределах этой сети получают запрос.

---

### **5. Ответ от целевого устройства**

- Устройство с указанным IP-адресом отправляет ARP-ответ. Ответ направляется исключительно маршрутизатору (unicast), указавшему запрос.
- В ARP-ответе содержится MAC-адрес целевого устройства.

---

### **6. Обновление ARP-кэша**

- Получив ARP-ответ, маршрутизатор добавляет или обновляет запись в своем ARP-кэше: IP-адрес ↔ MAC-адрес.
- Эта запись используется для последующих передач данных к этому устройству.

---

### **7. Передача данных**

- После успешного разрешения адреса маршрутизатор инкапсулирует IP-пакет в Ethernet-кадр, используя полученный MAC-адрес, и отправляет его в сторону целевого устройства.

---

### **Особые случаи:**

1. **Целевое устройство не отвечает:**  
    Если целевое устройство не отвечает, маршрутизатор может повторить запрос несколько раз. Если ответа нет, пакет отбрасывается, и может быть отправлено сообщение ICMP "Host unreachable".
    
2. **Протокол Proxy ARP:**  
    Если в сети используется Proxy ARP, другое устройство может ответить на запрос от имени целевого устройства.
    

---

### **Схематическое изображение процесса**:

1. **Маршрутизатор**: "Кто владеет IP 192.168.1.10?" → **Broadcast**
2. **Целевое устройство**: "Это мой IP! Вот мой MAC: 00:1A:2B:3C:4D:5E." → **Unicast к маршрутизатору**
3. **Маршрутизатор**: Сохраняет запись и отправляет данные.

### **Пример сценария, если есть запись в ARP-таблице:**

1. Устройство с IP `192.168.1.10` отправило данные ранее, и его MAC-адрес (`00:1A:2B:3C:4D:5E`) уже записан в ARP-кэше маршрутизатора.
2. Позже маршрутизатор получает новый пакет для `192.168.1.10`.
3. Маршрутизатор:
    - Проверяет ARP-кэш.
    - Видит, что MAC-адрес `00:1A:2B:3C:4D:5E` уже известен.
    - Инкапсулирует пакет и отправляет его без выполнения ARP-запроса.

## С устройством L2:

Когда устройство уровня 2 (например, коммутатор) участвует в передаче ARP-запроса, его роль заключается только в пересылке Ethernet-кадров, поскольку оно не оперирует IP-адресами. Вот пошаговый разбор:

---

### **1. Формирование ARP-запроса**

ARP-запрос инициируется устройством (например, компьютером или маршрутизатором) в локальной сети. Этот запрос инкапсулируется в Ethernet-кадр и отправляется широковещательно (MAC-адрес назначения: `FF:FF:FF:FF:FF:FF`).

---

### **2. Прием кадра коммутатором**

Коммутатор получает ARP-запрос через один из своих портов. На этом этапе он выполняет следующие действия:

- **Обновление таблицы MAC-адресов:**  
    Коммутатор сопоставляет MAC-адрес отправителя (источника) с портом, через который был получен кадр, и обновляет свою таблицу MAC-адресов. Это позволяет в будущем направлять кадры для этого MAC-адреса только через нужный порт.
    
    Пример:  
    Если кадр пришел через порт 1, а его источник имеет MAC-адрес `00:1A:2B:3C:4D:5E`, коммутатор добавляет запись:
    
    `00:1A:2B:3C:4D:5E → порт 1`
    

---

### **3. Широковещательная передача кадра**

Поскольку адрес назначения в ARP-запросе широковещательный (`FF:FF:FF:FF:FF:FF`), коммутатор отправляет этот кадр на все порты (кроме того, с которого он был получен).  
Это обеспечивает доставку запроса всем устройствам в локальной сети.

---

### **4. Обработка ARP-запроса конечными устройствами**

Каждое устройство в локальной сети проверяет IP-адрес, указанный в ARP-запросе:

- Если IP-адрес совпадает с его собственным, устройство формирует ARP-ответ, указывая свой MAC-адрес.
- Если IP-адрес не совпадает, устройство игнорирует запрос.

---

### **5. ARP-ответ**

Устройство, чей IP-адрес совпал, отправляет ARP-ответ:

- ARP-ответ инкапсулируется в Ethernet-кадр, где:
    - **MAC-адрес источника:** MAC-адрес устройства-ответчика.
    - **MAC-адрес назначения:** MAC-адрес устройства, сделавшего запрос.

Этот кадр направляется по адресу назначения.

---

### **6. Коммутатор и ARP-ответ**

- Когда ARP-ответ достигает коммутатора, он:
    - Проверяет MAC-адрес источника ответа и обновляет свою таблицу MAC-адресов.
    - Использует таблицу MAC-адресов для доставки кадра только на порт, соответствующий MAC-адресу назначения (это не широковещательная, а направленная передача).

---

### **7. Дальнейшая передача данных**

Теперь устройство-инициатор запроса знает MAC-адрес целевого устройства и может инкапсулировать IP-пакеты в Ethernet-кадры с правильным MAC-адресом назначения. Коммутатор, используя свою таблицу MAC-адресов, направляет кадры только на нужный порт.

---

### **Особенности работы коммутатора:**

1. **Не участвует в IP-адресации:**  
    Коммутатор работает исключительно с Ethernet-кадрами, MAC-адресами и своей таблицей MAC-адресов. Он не интерпретирует содержимое ARP-запроса или ответа.
    
2. **Динамическое обучение:**  
    Таблица MAC-адресов постоянно обновляется на основе входящих кадров. Если устройство сменило порт, запись автоматически обновится при следующем кадре.
    
3. **Флудирование широковещательных кадров:**  
    Все широковещательные кадры (включая ARP-запросы) отправляются на все порты в пределах одной VLAN.
    

---

### **Итог:**

Коммутатор выполняет роль "почтальона", передающего ARP-запросы и ответы между устройствами в сети. Он не понимает ARP на уровне IP, но обеспечивает эффективную доставку кадров за счет своей таблицы MAC-адресов.